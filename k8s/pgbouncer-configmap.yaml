apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  namespace: flash-sale
data:
  # PgBouncer configuration for high-concurrency Flash Sale system
  # Optimized for 1000 VU load testing with Cloud SQL backend
  pgbouncer.ini: |
    [databases]
    ; Connect to Cloud SQL PostgreSQL
    flash_sale = host=172.23.0.3 port=5432 dbname=flash_sale

    [pgbouncer]
    ; Connection pool mode: transaction is best for short-lived connections
    pool_mode = transaction

    ; Listen settings
    listen_addr = 0.0.0.0
    listen_port = 6432

    ; Authentication
    auth_type = md5
    auth_file = /etc/pgbouncer/userlist.txt

    ; Pool sizing - optimized for high concurrency
    ; max_client_conn: Maximum client connections PgBouncer will accept
    ; With HPA maxReplicas=15, 4 workers, pool_size=5: 15*4*5 = 300 connections
    max_client_conn = 500

    ; default_pool_size: Server connections per user/database pair
    default_pool_size = 25

    ; min_pool_size: Minimum server connections to keep ready
    min_pool_size = 5

    ; reserve_pool_size: Extra connections for burst traffic
    reserve_pool_size = 10

    ; reserve_pool_timeout: Wait time before using reserve pool
    reserve_pool_timeout = 3

    ; max_db_connections: Maximum connections to backend database
    ; Should not exceed Cloud SQL max_connections (typically 100-500)
    max_db_connections = 100

    ; max_user_connections: Maximum connections per user
    max_user_connections = 100

    ; Timeouts
    ; query_timeout: Maximum query execution time
    query_timeout = 30

    ; client_idle_timeout: Close idle client connections
    client_idle_timeout = 300

    ; server_idle_timeout: Close idle server connections
    server_idle_timeout = 60

    ; server_connect_timeout: Connection timeout to backend
    server_connect_timeout = 5

    ; server_login_retry: Retry connection after failure
    server_login_retry = 3

    ; Logging
    log_connections = 0
    log_disconnections = 0
    log_pooler_errors = 1
    stats_period = 60

    ; Admin settings
    admin_users = postgres
    stats_users = postgres

    ; TCP keepalive settings for Cloud SQL
    tcp_keepalive = 1
    tcp_keepidle = 30
    tcp_keepintvl = 10
    tcp_keepcnt = 3

    ; Disable prepared statements caching (required for transaction mode)
    ; Application must also set prepared_statement_cache_size=0
    ignore_startup_parameters = extra_float_digits

  userlist.txt: |
    "postgres" "postgres"
