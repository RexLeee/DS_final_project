<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時競標與限時搶購系統</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/night.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/monokai.css">
    <style>
        :root {
            --r-background-color: #1a1a2e;
            --r-main-color: #eaeaea;
            --r-heading-color: #00d9ff;
        }
        .reveal h1, .reveal h2, .reveal h3 { text-transform: none; font-weight: 700; }
        .reveal h1 { font-size: 2em; }
        .reveal h2 { font-size: 1.4em; color: #00d9ff; margin-bottom: 20px; }
        .reveal h3 { font-size: 0.95em; color: #7dd3fc; margin-bottom: 8px; }
        .reveal section { height: 100%; }
        .reveal table { font-size: 0.55em; margin: 0 auto; border-collapse: collapse; }
        .reveal table th { background: #0f3460; color: #00d9ff; }
        .reveal table td, .reveal table th { padding: 5px 10px; border: 1px solid #334; }
        .reveal pre { font-size: 0.45em; width: 100%; margin: 8px 0; }
        .reveal pre code { padding: 10px; max-height: 320px; }
        .reveal ul { display: block; text-align: left; margin-left: 1em; }
        .reveal ol { display: block; text-align: left; margin-left: 1em; }
        .reveal li { margin: 0.3em 0; font-size: 0.7em; }
        .reveal code { background: #16213e; padding: 2px 5px; border-radius: 4px; font-size: 0.85em; }

        .highlight-box {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border-left: 4px solid #00d9ff;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.7em;
        }
        .metric-card {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f3460 100%);
            padding: 12px 16px;
            border-radius: 10px;
            margin: 5px;
            display: inline-block;
            min-width: 120px;
        }
        .metric-card .value { font-size: 1.4em; font-weight: bold; color: #00d9ff; }
        .metric-card .label { font-size: 0.6em; color: #94a3b8; }
        .tech-badge {
            background: #0f3460;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.55em;
            margin: 4px;
            display: inline-block;
        }
        .check { color: #10b981; }
        .subtitle { color: #94a3b8; font-size: 0.85em; }

        .arch-container { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .arch-box {
            background: #16213e;
            border: 2px solid #0f3460;
            padding: 8px 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.5em;
        }
        .arch-box.client { border-color: #3b82f6; min-width: 320px; }
        .arch-box.ingress { border-color: #8b5cf6; min-width: 320px; }
        .arch-box.service { border-color: #10b981; min-width: 130px; }
        .arch-box.data { border-color: #f59e0b; min-width: 90px; }
        .arch-row { display: flex; gap: 15px; justify-content: center; align-items: flex-start; }
        .arch-arrow { color: #64748b; font-size: 0.65em; }

        .layer-box {
            background: #16213e;
            border-left: 4px solid;
            padding: 6px 12px;
            margin: 5px 0;
            border-radius: 0 8px 8px 0;
            text-align: left;
            font-size: 0.55em;
        }
        .layer-box.l1 { border-color: #ef4444; }
        .layer-box.l2 { border-color: #f59e0b; }
        .layer-box.l3 { border-color: #10b981; }
        .layer-box.l4 { border-color: #3b82f6; }

        .two-col { display: flex; gap: 20px; align-items: flex-start; }
        .two-col > div { flex: 1; }

        .three-col { display: flex; gap: 15px; align-items: flex-start; }
        .three-col > div { flex: 1; }

        .small-table { font-size: 0.5em !important; }
        .small-table td, .small-table th { padding: 4px 8px !important; }

        .flow-diagram {
            background: #16213e;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.42em;
            line-height: 1.4;
            text-align: left;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">

            <!-- ========== Slide 1: 封面 ========== -->
            <section>
                <h1>即時競標與限時搶購系統</h1>
                <p class="subtitle">分散式系統與雲端應用開發實務 — 期末專案</p>
                <br>
                <div>
                    <span class="tech-badge">FastAPI</span>
                    <span class="tech-badge">React 18</span>
                    <span class="tech-badge">PostgreSQL 15</span>
                    <span class="tech-badge">Redis 7</span>
                    <span class="tech-badge">Kubernetes</span>
                    <span class="tech-badge">GKE Autopilot</span>
                </div>
                <br><br>
                <p style="font-size: 0.6em; color: #64748b;">2025</p>
            </section>

            <!-- ========== Slide 2: 專案目標 ========== -->
            <section>
                <h2>專案目標與核心功能</h2>
                <div class="highlight-box" style="font-size: 0.8em;">
                    專為<strong style="color: #00d9ff;">高並發場景</strong>設計的即時競標系統<br>
                    活動結束時，排名前 K 名用戶自動成為得標者
                </div>
                <div style="margin: 20px 0;">
                    <div class="metric-card"><div class="value">1000+</div><div class="label">並發用戶 VUs</div></div>
                    <div class="metric-card"><div class="value">毫秒級</div><div class="label">出價響應</div></div>
                    <div class="metric-card"><div class="value">O(log N)</div><div class="label">排名查詢</div></div>
                    <div class="metric-card"><div class="value">100%</div><div class="label">庫存一致性</div></div>
                </div>
                <table style="font-size: 0.55em;">
                    <tr><td><strong>即時競標</strong></td><td>用戶對商品出價，系統即時計算排名</td></tr>
                    <tr><td><strong>限時搶購</strong></td><td>活動結束時，排名前 K 名用戶自動成為得標者</td></tr>
                    <tr><td><strong>庫存保護</strong></td><td>四層防超賣機制確保庫存一致性 (orders ≤ stock)</td></tr>
                    <tr><td><strong>即時推播</strong></td><td>WebSocket 推送排名更新與活動結果</td></tr>
                </table>
            </section>

            <!-- ========== Slide 3: 系統架構 ========== -->
            <section>
                <h2>系統架構</h2>
                <div class="arch-container">
                    <div class="arch-box client">
                        <strong>Client Layer</strong><br>
                        React 18 + TypeScript + Vite
                    </div>
                    <div class="arch-arrow">▼ HTTP / WebSocket</div>
                    <div class="arch-box ingress">
                        <strong>GCP Ingress (L7)</strong><br>
                        /api/* → Backend &nbsp;&nbsp; /* → Frontend
                    </div>
                    <div class="arch-arrow">▼</div>
                    <div class="arch-row">
                        <div class="arch-box service">
                            <strong>Backend</strong><br>
                            FastAPI + Uvicorn<br>
                            5-50 Pods (HPA)
                        </div>
                        <div class="arch-box service">
                            <strong>Frontend</strong><br>
                            Nginx + Static<br>
                            1-5 Pods (HPA)
                        </div>
                    </div>
                    <div class="arch-arrow">▼</div>
                    <div class="arch-row">
                        <div class="arch-box data">
                            <strong>Redis</strong><br>
                            Memorystore<br>1GB
                        </div>
                        <div class="arch-box data">
                            <strong>PgBouncer</strong><br>
                            6 Pods<br>Transaction
                        </div>
                        <div class="arch-box data">
                            <strong>PostgreSQL</strong><br>
                            Cloud SQL<br>2vCPU/4GB
                        </div>
                    </div>
                </div>
                <div class="highlight-box" style="margin-top: 15px; font-size: 0.65em;">
                    <strong>Namespace:</strong> flash-sale &nbsp;|&nbsp;
                    <strong>Ingress:</strong> GCP L7 LB &nbsp;|&nbsp;
                    <strong>Service:</strong> ClusterIP 內部發現
                </div>
            </section>

            <!-- ========== Slide 4: 雲端配置 ========== -->
            <section>
                <h2>雲端部署配置</h2>
                <table class="small-table">
                    <thead>
                        <tr><th>元件</th><th>技術</th><th>規格</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Backend</td><td>FastAPI + Uvicorn + uvloop</td><td>5-50 Pods, HPA CPU 50%</td></tr>
                        <tr><td>Frontend</td><td>React 18 + Nginx</td><td>1-5 Pods, HPA CPU 70%</td></tr>
                        <tr><td>PgBouncer</td><td>Connection Pooler</td><td>6 Pods, Transaction Mode</td></tr>
                        <tr><td>Redis</td><td>GCP Memorystore</td><td>1GB Basic Tier, Redis 7.0</td></tr>
                        <tr><td>PostgreSQL</td><td>Cloud SQL 15</td><td>2 vCPU / 4GB RAM / 10GB SSD, max_conn=200</td></tr>
                    </tbody>
                </table>
                <div class="two-col" style="margin-top: 15px;">
                    <div class="highlight-box">
                        <strong>連線池架構</strong><br>
                        Backend (50 Pods × 23 conn) = <strong>1,150</strong> 應用連線<br>
                        ↓ PgBouncer (6 × 30) ↓<br>
                        PostgreSQL = <strong>180</strong> DB 連線<br>
                        <strong style="color: #00d9ff;">連線複用比: 6.4 : 1</strong>
                    </div>
                    <div class="highlight-box">
                        <strong>Docker 映像</strong><br>
                        Backend: python:3.11-slim-bookworm<br>
                        <span style="font-size:0.9em; color:#94a3b8;">Multi-stage, UV 套件管理, uvloop + httptools</span><br>
                        Frontend: nginx:1.25-alpine<br>
                        <span style="font-size:0.9em; color:#94a3b8;">Multi-stage, Node 18 建置</span><br>
                        PgBouncer: edoburu/pgbouncer<br>
                        <span style="font-size:0.9em; color:#94a3b8;">輕量連線池代理</span>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 5: HPA 與 K8s 配置 ========== -->
            <section>
                <h2>HPA 擴展策略與 K8s 配置</h2>
                <div class="two-col">
                    <div>
                        <h3>HPA 擴展策略</h3>
                        <table class="small-table">
                            <thead><tr><th>方向</th><th>策略</th><th>說明</th></tr></thead>
                            <tbody>
                                <tr><td style="color:#10b981;"><strong>Scale Up</strong></td><td>無穩定窗口<br>每 15 秒 +10 pods</td><td>流量暴增快速應對</td></tr>
                                <tr><td style="color:#ef4444;"><strong>Scale Down</strong></td><td>5 分鐘穩定期<br>每 60 秒 -2 pods</td><td>避免縮容抖動</td></tr>
                            </tbody>
                        </table>
                        <div class="highlight-box" style="margin-top: 10px;">
                            <strong>觸發條件</strong><br>
                            Backend: CPU > 50% → 擴展 (5-50 Pods)<br>
                            Frontend: CPU > 70% → 擴展 (1-5 Pods)
                        </div>
                    </div>
                    <div>
                        <h3>Kubernetes 資源配置</h3>
                        <table class="small-table">
                            <thead><tr><th>資源類型</th><th>名稱</th><th>說明</th></tr></thead>
                            <tbody>
                                <tr><td>Namespace</td><td>flash-sale</td><td>專案隔離命名空間</td></tr>
                                <tr><td>Deployment</td><td>backend</td><td>單 worker/Pod + HPA 水平擴展</td></tr>
                                <tr><td>Deployment</td><td>frontend</td><td>Nginx 靜態檔案服務</td></tr>
                                <tr><td>Deployment</td><td>pgbouncer</td><td>6 Replicas 連線池代理</td></tr>
                                <tr><td>Service</td><td>ClusterIP</td><td>內部服務發現</td></tr>
                                <tr><td>Ingress</td><td>GCP L7 LB</td><td>/api/* → Backend, /* → Frontend</td></tr>
                                <tr><td>HPA</td><td>backend-hpa</td><td>CPU 50% 觸發，5-50 Pods</td></tr>
                                <tr><td>HPA</td><td>frontend-hpa</td><td>CPU 70% 觸發，1-5 Pods</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 6: 資料庫設計 ========== -->
            <section>
                <h2>資料庫 Schema 設計</h2>
                <div class="two-col">
                    <div>
                        <h3>ER Diagram</h3>
                        <div class="flow-diagram" style="font-size: 0.38em;">┌────────────┐           ┌────────────┐           ┌────────────┐
│   users    │           │    bids    │           │ campaigns  │
├────────────┤           ├────────────┤           ├────────────┤
│ user_id PK │◄──────────┤ user_id FK │     ┌────►│campaign_id │
│ email      │     1:M   │ campaign_id├─────┘     │ product_id │
│ username   │           │ price      │    M:1    │ start_time │
│ weight     │           │ score      │           │ end_time   │
│ is_admin   │           │ UNIQUE     │           │ alpha/beta │
└─────┬──────┘           │(camp,user) │           │ gamma      │
      │                  └────────────┘           └─────┬──────┘
      │                                                 │
      │                  ┌────────────┐                 │
      │           1:M    │   orders   │    M:1          │
      └─────────────────►├────────────┤◄────────────────┘
                         │ order_id PK│
                         │ final_price│
                         │ final_rank │     ┌────────────┐
                         │ UNIQUE     │     │  products  │
                         │(camp,user) │ M:1 ├────────────┤
                         └────────────┴────►│ product_id │
                                            │ stock      │
                                            │ min_price  │
                                            │ version    │
                                            └────────────┘</div>
                    </div>
                    <div>
                        <h3>表格定義</h3>
                        <table class="small-table">
                            <thead><tr><th>表格</th><th>主要欄位</th><th>特殊約束</th></tr></thead>
                            <tbody>
                                <tr><td><strong>users</strong></td><td>user_id, email, username, weight, is_admin</td><td>UNIQUE(email)</td></tr>
                                <tr><td><strong>products</strong></td><td>product_id, name, stock, min_price, version</td><td>CHECK(stock>=0)</td></tr>
                                <tr><td><strong>campaigns</strong></td><td>campaign_id, product_id, start/end_time, α/β/γ</td><td>CHECK(end>start)</td></tr>
                                <tr><td><strong>bids</strong></td><td>bid_id, campaign_id, user_id, price, score</td><td>UNIQUE(camp,user)</td></tr>
                                <tr><td><strong>orders</strong></td><td>order_id, campaign_id, user_id, final_price/rank</td><td>UNIQUE(camp,user)</td></tr>
                            </tbody>
                        </table>
                        <h3 style="margin-top: 12px;">關鍵索引</h3>
                        <table class="small-table">
                            <thead><tr><th>表格</th><th>索引</th><th>用途</th></tr></thead>
                            <tbody>
                                <tr><td>bids</td><td>idx_bids_campaign_score</td><td>排名查詢</td></tr>
                                <tr><td>bids</td><td>uq_bids_campaign_user</td><td>UPSERT 支援</td></tr>
                                <tr><td>campaigns</td><td>idx_campaigns_status</td><td>狀態篩選</td></tr>
                                <tr><td>campaigns</td><td>idx_campaigns_time</td><td>時間範圍查詢</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 7: 計分公式 ========== -->
            <section>
                <h2>計分公式</h2>
                <div class="highlight-box" style="font-size: 1em; text-align: center; max-width: 600px; margin: 0 auto;">
                    <strong style="color: #00d9ff; font-size: 1.3em;">Score = α × P + β / (T + 1) + γ × W</strong>
                </div>
                <div class="two-col" style="margin-top: 20px;">
                    <div>
                        <h3>參數說明</h3>
                        <table class="small-table">
                            <thead><tr><th>參數</th><th>說明</th><th>預設值</th></tr></thead>
                            <tbody>
                                <tr><td><strong>P</strong></td><td>出價金額</td><td>用戶輸入</td></tr>
                                <tr><td><strong>T</strong></td><td>活動開始後經過的毫秒數</td><td>系統計算</td></tr>
                                <tr><td><strong>W</strong></td><td>會員權重</td><td>0.5 - 5.0</td></tr>
                                <tr><td><strong>K</strong></td><td>商品庫存（得標名額）</td><td>活動設定</td></tr>
                                <tr><td><strong>α</strong></td><td>價格權重係數</td><td>1.0000</td></tr>
                                <tr><td><strong>β</strong></td><td>時間權重係數</td><td>1000.0000</td></tr>
                                <tr><td><strong>γ</strong></td><td>會員權重係數</td><td>100.0000</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h3>設計理念</h3>
                        <div class="highlight-box">
                            <strong style="color: #00d9ff;">越高出價</strong> → 越高分數 (α × P)<br><br>
                            <strong style="color: #00d9ff;">越早出價</strong> → 越高分數 (β / (T + 1))<br><br>
                            <strong style="color: #00d9ff;">越高會員等級</strong> → 越高分數 (γ × W)
                        </div>
                        <div class="highlight-box" style="margin-top: 10px;">
                            <strong>範例計算</strong><br>
                            P=5000, T=1000ms, W=3.0<br>
                            Score = 1×5000 + 1000/(1000+1) + 100×3<br>
                            Score = 5000 + 0.999 + 300 = <strong style="color:#00d9ff;">5300.999</strong>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 8: 出價流程 ========== -->
            <section>
                <h2>出價流程</h2>
                <div class="two-col">
                    <div>
                        <h3>流程圖</h3>
                        <div class="flow-diagram">┌────────┐  POST /bids   ┌─────────────┐
│ Client │──────────────►│Rate Limiter │
└────────┘               │ (Lua Script)│
                         └──────┬──────┘
                                │ Validate
                                ▼
                         ┌─────────────┐
                         │  Campaign   │
                         │ Validation  │
                         │(Redis Cache)│
                         └──────┬──────┘
                                │
                                ▼
                         ┌─────────────┐
                         │  Calculate  │
                         │    Score    │
                         └──────┬──────┘
                                │
          ┌─────────────────────┴─────────────────────┐
          ▼                                           ▼
   ┌──────────────┐                          ┌──────────────┐
   │  PostgreSQL  │                          │    Redis     │
   │   UPSERT     │                          │  Pipeline    │
   │  (Atomic)    │                          │ZADD+HSET+RANK│
   └──────┬───────┘                          └──────┬───────┘
          │                                         │
          └─────────────────┬─────────────────────┘
                            ▼
                    ┌──────────────┐
                    │  WebSocket   │
                    │ bid_accepted │
                    └──────────────┘</div>
                    </div>
                    <div>
                        <h3>關鍵技術：UPSERT</h3>
                        <pre><code class="language-python">stmt = pg_insert(Bid).values(
    campaign_id=cid,
    user_id=uid,
    price=price,
    score=score,
)
stmt = stmt.on_conflict_do_update(
    index_elements=[
        'campaign_id', 'user_id'
    ],
    set_={
        'price': price,
        'score': score,
        'bid_number': Bid.bid_number + 1
    }
)</code></pre>
                        <p style="font-size: 0.55em; color: #94a3b8;">
                            <span class="check">✓</span> INSERT ... ON CONFLICT DO UPDATE<br>
                            <span class="check">✓</span> 單一 SQL，原子操作<br>
                            <span class="check">✓</span> 消除競態條件
                        </p>
                        <h3 style="margin-top: 10px;">Redis Pipeline</h3>
                        <p style="font-size: 0.55em; color: #94a3b8;">
                            ZADD + HSET + ZREVRANK 合併為 <strong style="color:#00d9ff;">1 RTT</strong><br>
                            減少 <strong style="color:#00d9ff;">40-60%</strong> 延遲
                        </p>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 9: 結算流程 ========== -->
            <section>
                <h2>結算流程</h2>
                <div class="two-col">
                    <div>
                        <h3>流程圖</h3>
                        <div class="flow-diagram">┌───────────────┐
│ Background    │
│ Loop (10s)    │
└───────┬───────┘
        │
        ▼
┌─────────────────┐
│ Query Campaigns │
│ status='active' │
│ end_time < now  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Get Top K from │
│  Redis Sorted   │
│      Set        │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  Four-Layer Protection  │
│                         │
│  L1: Redis 分散式鎖     │
│  L2: Redis Lua 原子扣減 │
│  L3: PostgreSQL 行級鎖  │
│  L4: 樂觀鎖 (version)   │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│   Create Order Records  │
│  Broadcast campaign_end │
└─────────────────────────┘</div>
                    </div>
                    <div>
                        <h3>結算程式碼</h3>
                        <pre><code class="language-python">async def settlement_loop():
    while True:
        # 查詢已結束的活動
        campaigns = await get_ended_campaigns()

        for campaign in campaigns:
            # 從 Redis 取得 Top K 排名
            winners = await redis.zrevrange(
                f"bid:{campaign.id}",
                0, campaign.stock - 1,
                withscores=True
            )

            # 執行四層保護 + 建立訂單
            for rank, (user_id, score) in enumerate(winners):
                await create_order_with_protection(
                    campaign, user_id, score, rank + 1
                )

            # 更新活動狀態
            campaign.status = 'ended'

            # WebSocket 廣播結果
            await broadcast_campaign_end(campaign)

        await asyncio.sleep(10)</code></pre>
                        <p style="font-size: 0.55em; color: #94a3b8;">
                            <span class="check">✓</span> 每 10 秒檢查已結束活動<br>
                            <span class="check">✓</span> Redis ZREVRANGE 取得 Top K<br>
                            <span class="check">✓</span> 四層保護確保庫存一致
                        </p>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 10: 四層防超賣 ========== -->
            <section>
                <h2>四層防超賣機制</h2>
                <p style="font-size: 0.65em; color: #94a3b8; margin-bottom: 12px;">
                    問題：高並發結算時如何確保 <strong style="color:#00d9ff;">orders ≤ stock</strong>？
                </p>
                <div style="max-width: 700px; margin: 0 auto;">
                    <div class="layer-box l1">
                        <strong>L1: Redis 分散式鎖</strong> — <code>SET lock:product:{id} NX EX 2</code>
                        <span style="float:right; color:#94a3b8;">序列化並發請求</span>
                    </div>
                    <div class="layer-box l2">
                        <strong>L2: Redis Lua 原子扣減</strong> — <code>if stock >= 1 then DECR</code>
                        <span style="float:right; color:#94a3b8;">快速庫存檢查</span>
                    </div>
                    <div class="layer-box l3">
                        <strong>L3: PostgreSQL 行級鎖</strong> — <code>SELECT ... FOR UPDATE</code>
                        <span style="float:right; color:#94a3b8;">鎖定該行資料</span>
                    </div>
                    <div class="layer-box l4">
                        <strong>L4: 樂觀鎖版本檢查</strong> — <code>UPDATE WHERE version = ?</code>
                        <span style="float:right; color:#94a3b8;">最終一致性保證</span>
                    </div>
                </div>
                <div class="two-col" style="margin-top: 15px;">
                    <pre><code class="language-lua">-- Redis Lua: 庫存原子扣減
local stock = tonumber(redis.call("GET", KEYS[1]))
if stock and stock >= 1 then
    return redis.call("DECR", KEYS[1])
else
    return -1  -- 庫存不足
end</code></pre>
                    <pre><code class="language-python"># PostgreSQL 樂觀鎖
result = await session.execute(
    update(Product)
    .where(Product.id == pid)
    .where(Product.version == current_ver)
    .values(stock=Product.stock - 1,
            version=current_ver + 1)
)
if result.rowcount == 0:
    raise OptimisticLockError()</code></pre>
                </div>
            </section>

            <!-- ========== Slide 11: Redis 資料結構與排名效能 ========== -->
            <section>
                <h2>Redis 資料結構與排名效能</h2>
                <div class="two-col">
                    <div>
                        <h3>Redis 資料結構</h3>
                        <table class="small-table">
                            <thead><tr><th>Key Pattern</th><th>結構</th><th>用途</th></tr></thead>
                            <tbody>
                                <tr><td><code>bid:{campaign_id}</code></td><td>Sorted Set</td><td>排名 (user_id → score)</td></tr>
                                <tr><td><code>bid_details:{cid}:{uid}</code></td><td>Hash</td><td>出價詳情 (price, username)</td></tr>
                                <tr><td><code>stock:{product_id}</code></td><td>String</td><td>即時庫存計數器</td></tr>
                                <tr><td><code>lock:product:{pid}</code></td><td>String</td><td>分散式鎖 (TTL 2秒)</td></tr>
                            </tbody>
                        </table>
                        <h3 style="margin-top: 15px;">排名查詢效能</h3>
                        <table class="small-table">
                            <thead><tr><th>操作</th><th>時間複雜度</th></tr></thead>
                            <tbody>
                                <tr><td>更新排名 (ZADD)</td><td>O(log N)</td></tr>
                                <tr><td>查詢單人排名 (ZREVRANK)</td><td>O(log N)</td></tr>
                                <tr><td>取得 Top K (ZREVRANGE)</td><td>O(log N + K)</td></tr>
                                <tr><td>總參與人數 (ZCARD)</td><td>O(1)</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h3>Pipeline 優化</h3>
                        <pre><code class="language-python"># 傳統做法：3 次 RTT
await redis.zadd(key, {uid: score})  # RTT 1
await redis.hset(details_key, data)  # RTT 2
rank = await redis.zrevrank(key, uid)  # RTT 3

# Pipeline：1 次 RTT
pipe = redis.pipeline()
pipe.zadd(key, {uid: score})
pipe.hset(details_key, data)
pipe.zrevrank(key, uid)
results = await pipe.execute()  # 只需 1 RTT!</code></pre>
                        <div style="margin-top: 15px;">
                            <div class="metric-card"><div class="value">40-60%</div><div class="label">延遲減少</div></div>
                            <div class="metric-card"><div class="value">1 RTT</div><div class="label">vs 3 RTT</div></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 12: API 設計 ========== -->
            <section>
                <h2>API 設計</h2>
                <div class="two-col">
                    <div>
                        <h3>REST API 端點</h3>
                        <table class="small-table">
                            <thead><tr><th>方法</th><th>端點</th><th>說明</th><th>認證</th></tr></thead>
                            <tbody>
                                <tr><td>POST</td><td>/api/v1/auth/register</td><td>用戶註冊</td><td>-</td></tr>
                                <tr><td>POST</td><td>/api/v1/auth/login</td><td>登入取得 JWT</td><td>-</td></tr>
                                <tr><td>GET</td><td>/api/v1/auth/me</td><td>當前用戶資訊</td><td>Required</td></tr>
                                <tr><td>GET</td><td>/api/v1/products</td><td>商品列表</td><td>-</td></tr>
                                <tr><td>POST</td><td>/api/v1/products</td><td>建立商品</td><td>Admin</td></tr>
                                <tr><td>GET</td><td>/api/v1/campaigns</td><td>活動列表</td><td>-</td></tr>
                                <tr><td>GET</td><td>/api/v1/campaigns/{id}</td><td>活動詳情（含統計）</td><td>-</td></tr>
                                <tr><td>POST</td><td>/api/v1/campaigns</td><td>建立活動</td><td>Admin</td></tr>
                                <tr><td style="color:#00d9ff;"><strong>POST</strong></td><td style="color:#00d9ff;"><strong>/api/v1/bids</strong></td><td style="color:#00d9ff;"><strong>提交出價</strong></td><td>Required</td></tr>
                                <tr><td>GET</td><td>/api/v1/rankings/{id}</td><td>Top K 排名</td><td>-</td></tr>
                                <tr><td>GET</td><td>/api/v1/rankings/{id}/me</td><td>自己的排名</td><td>Required</td></tr>
                                <tr><td>GET</td><td>/api/v1/orders</td><td>我的訂單列表</td><td>Required</td></tr>
                                <tr><td>GET</td><td>/api/v1/orders/campaign/{id}</td><td>活動訂單（驗證一致性）</td><td>Admin</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h3>WebSocket</h3>
                        <p style="font-size: 0.5em; color: #94a3b8;">端點：<code>ws://host/ws/{campaign_id}?token={jwt}</code></p>
                        <table class="small-table">
                            <thead><tr><th>事件</th><th>方向</th><th>觸發時機</th><th>說明</th></tr></thead>
                            <tbody>
                                <tr><td><code>ranking_update</code></td><td>S → C</td><td>每 2 秒</td><td>廣播 Top K 排名</td></tr>
                                <tr><td><code>bid_accepted</code></td><td>S → C</td><td>出價成功</td><td>推送用戶當前排名</td></tr>
                                <tr><td><code>campaign_ended</code></td><td>S → C</td><td>活動結算</td><td>通知最終結果</td></tr>
                                <tr><td><code>ping/pong</code></td><td>雙向</td><td>心跳檢測</td><td>維持連線</td></tr>
                            </tbody>
                        </table>
                        <h3 style="margin-top: 10px;">排名廣播資料結構</h3>
                        <pre style="font-size: 0.4em;"><code class="language-json">{
  "event": "ranking_update",
  "data": {
    "campaign_id": "uuid",
    "top_k": [
      {"rank": 1, "user_id": "...", "score": 15000.5,
       "price": 5000, "username": "..."}
    ],
    "total_participants": 1000,
    "min_winning_score": 12000,
    "max_score": 15000.5
  }
}</code></pre>
                    </div>
                </div>
            </section>

            <!-- ========== Slide 13: Q&A ========== -->
            <section>
                <h1>謝謝聆聽</h1>
                <br>
                <p style="font-size: 1.1em; color: #94a3b8;">Q&A</p>
                <br>
                <div class="two-col" style="max-width: 900px; margin: 0 auto;">
                    <div style="text-align: left;">
                        <p style="font-size: 0.6em;">
                            <span class="check">✓</span> <strong>PostgreSQL UPSERT</strong><br>
                            <span style="color:#94a3b8; margin-left: 18px;">原子操作，高並發安全</span><br><br>
                            <span class="check">✓</span> <strong>Redis Sorted Set</strong><br>
                            <span style="color:#94a3b8; margin-left: 18px;">O(log N) 毫秒級排名</span><br><br>
                            <span class="check">✓</span> <strong>四層防超賣</strong><br>
                            <span style="color:#94a3b8; margin-left: 18px;">100% 庫存一致性保證</span>
                        </p>
                    </div>
                    <div style="text-align: left;">
                        <p style="font-size: 0.6em;">
                            <span class="check">✓</span> <strong>Redis Pipeline</strong><br>
                            <span style="color:#94a3b8; margin-left: 18px;">減少 40-60% 延遲</span><br><br>
                            <span class="check">✓</span> <strong>WebSocket 即時推播</strong><br>
                            <span style="color:#94a3b8; margin-left: 18px;">2 秒排名更新</span><br><br>
                            <span class="check">✓</span> <strong>HPA + PgBouncer</strong><br>
                            <span style="color:#94a3b8; margin-left: 18px;">支撐 1000+ VU 並發</span>
                        </p>
                    </div>
                </div>
                <br>
                <div>
                    <span class="tech-badge">FastAPI</span>
                    <span class="tech-badge">React 18</span>
                    <span class="tech-badge">PostgreSQL 15</span>
                    <span class="tech-badge">Redis 7</span>
                    <span class="tech-badge">Kubernetes</span>
                    <span class="tech-badge">GKE Autopilot</span>
                </div>
            </section>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/highlight.js"></script>
    <script>
        Reveal.initialize({
            hash: true,
            slideNumber: 'c/t',
            plugins: [RevealHighlight],
            transition: 'slide',
            width: 1200,
            height: 700,
            margin: 0.08,
        });
    </script>
</body>
</html>
